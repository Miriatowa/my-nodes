# UBT学习手册

### 概念

用户行为数据采集系统（简称UBT），是一个网站跟踪工具，通过PV、转化率、设备、软件环境、访客地理位置分布、用户操作习惯等数据，帮助产品组合业务部分能更好的了解用户的需求，深入改进产品。

### 功能

网站页面流量统计(PV)、网站性能统计(Performance)、用户表单填写警告统计（User Block）、页面JS错误统计（JS Error）、页面元素点击量统计（User Action）、自定义数据采集（Trancelog）

### 术语

| 字段                  | 含义                                                         |
| --------------------- | ------------------------------------------------------------ |
| VID                   | UBT用于标识用户的字段，基于本地存储，依赖Agent（不同Agent下值不一样） |
| SID                   | UBT用于标识session会话周期的字段，session有效期为30分钟      |
| PVID                  | UBT用于标识单次PV的ID字段                                    |
| Visits                | 指网站被访客访问的次数，不考虑是否重复访客                   |
| UV（Unique Visitors） | 指访问网站的真实的人的数量，即独立访客。UBT中使用VID来唯一指示一个访客 |
| Sessions              | 就是访问的次数，和Visits相同。UBT使用SID来表示某一访客的某次访问 |
| PageViews（PV）       | 指网站被访客访问的总的网页计数。UBT使用PVID来表示某一访客某一次访问的pv情况 |
| PageView              | 指网站中某一个page被访问，UBT使用PageID来标识一个Page        |
| Cookie                | cookie是UBT系统的基础，UBT很多技术就是基于cookie，比如如何识别一个访客、如何判断是否重复访客、如何记录一次访问的各种信息等等 |
| 转化                  | 访客在访问网站中完成了一些动作，由淡出的访客逐步转化为客户。转化既可以是关键转化，也可以是次要转化。关键转化通常是指提交订单，完成购买。次要转化是指完成注册等活动，表明用户正在一步步接近关键转化 |
| Referer               | Referer是HTTP表头的一个字段，用来表示访客从哪来链接当前的网页，采用的格式是URL。Referer在http的网页转向https的网页访问中可能会丢失 |

### 数据采集原理

用户访问带有UBT采集脚本的页面时，页面中的采集脚本加载完成后，会检测页面是否有pageid, 如果存在有效的pageid，采集脚本会立即把采集到的数据作为参数通过HTTP Get方式请求后端服务器上的一张1*1大小的图片，带回数据，这个过程称之为发送数据； 如果页面没有有效的pageid, 采集脚本会在domready之后发送数据，并且把page_id设为0，后续会处理；如果pageid的默认值设为wait, 采集脚本会在pageid的值更新后再发送数据。 数据发送完成后，后端服务器处理数据，把数据推送到消息队列，并持久化到Hbase，RCFile，供用户使用。

UBT online站点是通过cookie来存放数据的，vid生成，sid, pvid统计等，部分数据是通过网页埋点采集的，包含大部分业务数据；部分采集客户端浏览器的信息，比如浏览器头信息，User-Agent,Referrer等；还有一部分来自浏览器的原生api,如网页性能数据。目前高版本浏览器提供的获取网页性能API：Navigation Timing，可以得到以下数据：

### 埋点类型

UBT埋点有两大类，一是自动化的，二是用户自定义的。前者由UBT通过监测事件自动埋点，比如PV和点击现在均可以自动化收集；后者为用户自行埋点，一般用于对自动埋点的补充，实现特定的场景需求，如自定义的trace埋点等。

#### 自动化埋点

自动化埋点主要包括以下：

1. Pageview (web端，含h5、hybrid)

   Web环境下，随着页面加载相关事件的触发，会自动发送PV数据。用户需要申请pageId并部署到页面上。另外做为特例，[单页](http://docs.ubt.ctripcorp.com/books/ubt-manual/essentials/concepts#单页应用)模式下，如果用了[lizard](http://docs.ubt.ctripcorp.com/books/ubt-manual/appendices/lizard)框架，框架会自动发PV，但需按相关规范提供pageId等；如果没有使用lizard，模拟的页面切换需要用户手工调相应的API来发送PV数据。

2. UserAction (即点击事件，含web端和app端)

   UBT在web端和app端均实现了用户点击事件的统一收集。点击的元素按其在页面（或视图）中的位置，以XPath的形式标识。

3. Page/Service Performance

   在web端，UBT会按照w3c规范收集由浏览器提供的页面性能相关数据，包括网络连接、页面加载与渲染等的各项耗时。在app端，基础业务部门对服务调用等进行了统一的耗时埋点，通常BU不需要再做相关记录。

#### 用户自定义

当你的需求超出上述自动化埋点覆盖范围时，你可能需要发一些完全自定义的埋点，来实现特定的需求。常用自定义埋点有以下几种：

1. Trace

   自定义数据收集。除了基本的上下文环境（会自动带上），其它数据完全由用户指定。该种自定义埋点可满足大多数需求，是最常用的自定义埋点。UBT对于客户端的Trace埋点提供实时的计数统计。

2. Metric

   自定义数值型数据收集。它和Trace的差别主要在于内容为数值，可以指定维度，专门用于类似性能耗时这类统计。UBT实时提供数据汇聚结果报表。

3. EDM

   多数用户不需要关注该种类型埋点。此埋点用于邮件打开统计，没有会话等的识别信息。数据内容基本由用户生成邮件时提供